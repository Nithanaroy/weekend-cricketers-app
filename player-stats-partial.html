<link href="https://unpkg.com/bootstrap-table@1.18.3/dist/bootstrap-table.min.css" rel="stylesheet">
<script src="https://unpkg.com/bootstrap-table@1.18.3/dist/bootstrap-table.min.js"></script>

<div>
	<table id="table" data-toggle="table" data-search="true" data-search-align="left" data-pagination="true"
		data-sort-name="days" data-sort-order="desc">
		<thead>
			<tr>
				<!-- <th data-field="id" data-searchable="false">ID</th> -->
				<th data-field="name" data-sortable="true">Player Name</th>
				<th data-field="days" data-sortable="true">Days</th>
			</tr>
		</thead>
	</table>

	<script>
		var $table = $('#table');
    const MIN_DURATION_TO_UPDATE_CACHE_IN_MS = 10 * 60 * 1000

    function updatePlayerStatsCache() {
        google.script.run.withFailureHandler((error) => {
          onFailure("Server errored out when trying to update stats for future use", error, "warning");
      }).getPlayCounts(null, false);
    }

    function fetchNumGameDaysPerPlayer() {
      $table.bootstrapTable('showLoading');
      google.script.run.withSuccessHandler(({playersTally, _meta}) => {
        showAlert(`These stats were last updated at ${new Date(_meta.updatedAt)}`, "success")
        $table.bootstrapTable('load', playersTally)
        $table.bootstrapTable('hideLoading');
        if(new Date().getTime() - _meta.updatedAt > MIN_DURATION_TO_UPDATE_CACHE_IN_MS) {
          updatePlayerStatsCache();
        }
      }).withFailureHandler((error) => {
          onFailure("Failed to fetch the data :(", error);
          $table.bootstrapTable('hideLoading');
      }).getPlayCounts();
    }
    

  $(function() {
    $table.bootstrapTable();
    fetchNumGameDaysPerPlayer();
  })
	</script>
</div>